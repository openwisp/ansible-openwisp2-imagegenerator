- name: "Remove {{ openwisp2fw_generator_dir }} (cleanup)"
  file:
    path: "{{ openwisp2fw_generator_dir }}"
    state: absent

- name: "Create {{ openwisp2fw_generator_dir }}"
  file:
    path: "{{ openwisp2fw_generator_dir }}"
    state: directory

- name: Create find scripts on server
  template:
    src: generator/find.sh.jinja2
    dest: "{{ openwisp2fw_source_dir }}/find-{{ item.system }}-{{ item.subtarget }}.sh"
    mode: 0755
  with_items: "{{ openwisp2fw_source_targets }}"

- name: Call find scripts
  shell: "{{ openwisp2fw_source_dir }}/find-{{ item.system }}-{{ item.subtarget }}.sh"
  args:
    chdir: "{{ openwisp2fw_source_dir }}"
    creates: "{{ openwisp2fw_generator_dir }}/{{ item.system }}-{{ item.subtarget }}.gz"
  with_items: "{{ openwisp2fw_source_targets }}"

- name: Extract copies of imagebuilder archives
  unarchive:
    copy: false
    src: "{{ openwisp2fw_generator_dir }}/{{ item.system }}-{{ item.subtarget }}.gz"
    dest: "{{ openwisp2fw_generator_dir }}"
    creates: "{{ openwisp2fw_generator_dir }}/.archive-{{ item.system }}-{{ item.subtarget }}-created"
  with_items: "{{ openwisp2fw_source_targets }}"

- name: Remove copies of imagebuilder archives
  file:
    dest: "{{ openwisp2fw_generator_dir }}/{{ item.system }}-{{ item.subtarget }}.gz"
    state: absent
  with_items: "{{ openwisp2fw_source_targets }}"

- name: Rename ImageBuilder dirs to just the name of their corresponding target system
  shell: "mv *-{{ item.system }}-{{ item.subtarget }}* {{ item.system }}-{{ item.subtarget }}"
  args:
    chdir: "{{ openwisp2fw_generator_dir }}"
    creates: "{{ openwisp2fw_generator_dir }}/{{ item.system }}-{{ item.subtarget }}"
  with_items: "{{ openwisp2fw_source_targets }}"

- name: Create a "files" directory for each organization
  file:
    path: "{{ openwisp2fw_generator_dir }}/files/{{ item.name }}"
    state: directory
  with_items: "{{ openwisp2fw_organizations }}"

- name: Copy general role files to each organization
  copy:
    dest: "{{ openwisp2fw_generator_dir }}/files/{{ item.name }}"
    src: files/
  with_items: "{{ openwisp2fw_organizations }}"

# the following task checks whether <playbook-dir>/files/ exists
# and stores the result of this check in a variable
- name: check local /files dir
  local_action: stat path={{ playbook_dir }}/files
  become: false
  register: file_dir

# perform action only if playbook_dir contains a file directory
- name: Copy general playbook files to each organization
  copy:
    dest: "{{ openwisp2fw_generator_dir }}/files/{{ item.name }}"
    src: "{{ playbook_dir }}/files/"
  with_items: "{{ openwisp2fw_organizations }}"
  when: file_dir.stat.exists == true

- name: /etc/config/openwisp
  template:
    dest: "{{ openwisp2fw_generator_dir }}/files/{{ item.name }}/etc/config/openwisp"
    src: uci/openwisp.jinja2
  with_items: "{{ openwisp2fw_organizations }}"
  when: item.openwisp is defined

- name: /etc/config/luci_openwisp
  template:
    dest: "{{ openwisp2fw_generator_dir }}/files/{{ item.name }}/etc/config/luci_openwisp"
    src: uci/luci_openwisp.jinja2
  with_items: "{{ openwisp2fw_organizations }}"
  when: item.luci_openwisp is defined

- name: /etc/shadow
  template:
    dest: "{{ openwisp2fw_generator_dir }}/files/{{ item.name }}/etc/shadow"
    src: generator/shadow.jinja2
    mode: 0600
  with_items: "{{ openwisp2fw_organizations }}"
  when: item.root_password is defined

# the following task loops over each organization and checks whether
# <playbook-dir>/organizations/<organization-name>/ exists
# and stores the result of this check in a variable
- name: check local /organizations dir
  local_action: stat path={{ playbook_dir }}/organizations/{{ item.name }}
  become: false
  register: organization_dirs
  with_items: "{{ openwisp2fw_organizations }}"

# perform action only if corresponding organization directory exist
# eg:
#   if <playbook-dir>/organizations/<organization-name> exists
#   then include its contents
- name: Copy organization specific files stored in playbook directory
  copy:
    dest: "{{ openwisp2fw_generator_dir }}/files/{{ item.item.name }}"
    src: "{{ playbook_dir }}/organizations/{{ item.item.name }}/"
  with_items: "{{ organization_dirs.results }}"
  when: item.stat.exists == true
